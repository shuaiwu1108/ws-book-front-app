<template>
	<view class="page-news">
		<!-- #ifdef APP-NVUE -->
		<list class="listview">
			<refresh :display="refreshing" @refresh="onrefresh" @pullingdown="onpullingdown"></refresh>
			<cell v-for="(item, index) in dataList" :key="item.id">
				<book-info :bookInfo="item" @close="closeItem(index)" @click="goDetail(item)"></book-info>
			</cell>
			<cell v-if="isLoading || dataList.length > 4">
				<view class="loading-more">
					<text class="loading-more-text">{{loadingText}}</text>
				</view>
			</cell>
		</list>
		<!-- #endif -->
		<!-- #ifndef APP-NVUE -->
		<scroll-view class="listview" style="flex: 1;" enableBackToTop="true" scroll-y @scrolltolower="loadMore()">
			<view v-for="(item, index) in dataList" :key="item.id">
				<book-info :bookInfo="item" @close="closeItem(index)" @click="goDetail(item)"></book-info>
			</view>
			<view class="loading-more" v-if="isLoading || dataList.length > 4">
				<text class="loading-more-text">{{loadingText}}</text>
			</view>
		</scroll-view>
		<!-- #endif -->
	</view>
</template>

<script>
	import {
		friendlyDate
	} from '@/common/util.js';

	import bookInfo from './news-item.nvue';
	import uniLoadMore from '@/components/uni-load-more.vue';

	export default {
		components: {
			uniLoadMore,
			bookInfo
		},
		props: {
			booktype: {
				type: [String],
				default: ''
			}
		},
		data() {
			return {
				dataList: [],
				navigateFlag: false,
				pulling: false,
				refreshing: false,
				refreshFlag: false,
				refreshText: "",
				isLoading: false,
				loadingText: '加载中...',
				isNoData: false,
				pulling: false,
				angle: 0,
				listCount: 1,
				loadingMoreText: {
					contentdown: '',
					contentrefresh: '',
					contentnomore: ''
				},
				refreshIcon: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAB5QTFRFcHBw3Nzct7e39vb2ycnJioqK7e3tpqam29vb////D8oK7wAAAAp0Uk5T////////////ALLMLM8AAABxSURBVHja7JVBDoAgDASrjqj//7CJBi90iyYeOHTPMwmFZrHjYyyFYYUy1bwUZqtJIYVxhf1a6u0R7iUvWsCcrEtwJHp8MwMdvh2amHduiZD3rpWId9+BgPd7Cc2LIkPyqvlQvKxKBJ//Qwq/CacAAwDUv0a0YuKhzgAAAABJRU5ErkJggg=="
			}
		},
		created() {
			this.pullTimer = null;
			this.requestParams = {
				source: "bqg",
				bookType: this.booktype,
				pageIndex: 1,
				pageSize: 10
			};

			this._isWidescreen = false;
			// #ifdef H5
			// #endif
		},
		methods: {
			loadData(refresh) {
				if (this.isLoading) {
					return;
				}
				
				if(this.isNoData){
					this.loadingText = '到底啦'
					return;
				}

				this.isLoading = true;
				this.isNoData = false;
				this.requestParams.pageIndex = this.listCount;

				uni.request({
					// url: this.$host + 'api/news',
					// url: 'https://unidemo.dcloud.net.cn/api/news',
					url: 'http://192.168.1.20:9090/api/book/list',
					data: this.requestParams,
					method: 'POST',
					success: (result) => {
						const data = result.data;
						if(data == null || data.length < 10){
							this.isNoData = true;
							this.loadingText = '到底啦'
							return;
						}

						const data_list = data.map((book) => {
							return {
								id: book.id,
								article_type: 1,
								description: book.description,
								icon: book.icon,
								name: book.name,
								author_name: book.authorId,
								book_source: book.bookSource
							};
						});
						
						

						if (refresh) {
							this.dataList = data_list;
							this.requestParams.pageIndex = 1;
							this.listCount = 1;
							console.info(this.listCount)
						} else {
							this.dataList = this.dataList.concat(data_list);
							this.listCount = this.listCount + 1
						}

						if (this.dataList.length > 0 && this._isWidescreen && this.dataList.length <= 10) {
							this.goDetail(this.dataList[0]);
						}
					},
					fail: (err) => {
						if (this.dataList.length == 0) {
							this.isNoData = true;
						}
					},
					complete: (e) => {
						this.isLoading = false;
						if (refresh) {
							this.refreshing = false;
							this.refreshFlag = false;
							this.refreshText = "已刷新";
							if (this.pullTimer) {
								clearTimeout(this.pullTimer);
							}
							this.pullTimer = setTimeout(() => {
								this.pulling = false;
							}, 1000);
						}
					}
				});
			},
			loadMore(e) {
				this.loadData();
			},
			clear() {
				this.dataList.length = 0;
				this.requestParams.pageIndex = 1;
				this.listCount = 0;
			},
			goDetail(detail) {
				if (this._isWidescreen) { //若为宽屏，则触发右侧详情页的自定义事件
					uni.$emit('updateDetail', {
						detail: encodeURIComponent(JSON.stringify(detail))
					})
				} else {
					uni.navigateTo({
						url: './detail?query=' + encodeURIComponent(JSON.stringify(detail))
					});
				}
			},
			refreshData() {
				if (this.isLoading) {
					return;
				}
				this.pulling = true;
				this.refreshing = true;
				this.refreshText = "正在刷新...";
				this.loadData(true);
			},
			onrefresh(e) {
				this.refreshData();
				// #ifdef APP-NVUE
				this.$refs.list.resetLoadmore();
				// #endif
			},
			onpullingdown(e) {
				if (this.refreshing) {
					return;
				}
				this.pulling = false;
				if (Math.abs(e.pullingDistance) > Math.abs(e.viewHeight)) {
					this.refreshFlag = true;
					this.refreshText = "释放立即刷新";
				} else {
					this.refreshFlag = false;
					this.refreshText = "下拉可以刷新";
				}
			}
		}
	}
</script>

<style scoped>
	.no-data {
		flex: 1;
		position: absolute;
		left: 0;
		top: 0;
		right: 0;
		bottom: 0;
		z-index: 10;
	}

	.page-news {
		flex: 1;
		flex-direction: column;
		position: absolute;
		left: 0;
		top: 0;
		right: 0;
		bottom: 0;
	}

	.listview {
		position: absolute;
		left: 0;
		top: 0;
		right: 0;
		bottom: 0;
		/* #ifndef APP-NVUE */
		display: flex;
		flex-direction: column;
		/* #endif */
		/* #ifndef MP-ALIPAY */
		flex-direction: column;
		/* #endif */
	}

	.refresh {
		justify-content: center;
	}

	.refresh-view {
		/* #ifndef APP-NVUE */
		display: flex;
		/* #endif */
		width: 750rpx;
		height: 64px;
		flex-direction: row;
		flex-wrap: nowrap;
		align-items: center;
		justify-content: center;
	}

	.refresh-icon {
		width: 32px;
		height: 32px;
		transition-duration: .5s;
		transition-property: transform;
		transform: rotate(0deg);
		transform-origin: 15px 15px;
	}

	.refresh-icon-active {
		transform: rotate(180deg);
	}

	.loading-icon {
		width: 28px;
		height: 28px;
		margin-right: 5px;
		color: gray;
	}

	.loading-text {
		margin-left: 2px;
		font-size: 16px;
		color: #999999;
	}

	.loading-more {
		align-items: center;
		justify-content: center;
		padding-top: 14px;
		padding-bottom: 14px;
		text-align: center;
	}

	.loading-more-text {
		font-size: 28upx;
		color: #999;
	}
</style>